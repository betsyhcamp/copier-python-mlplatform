version: '3'

tasks:
  # ===========================================
  # DEPENDENCIES
  # ===========================================
  install:
    desc: Install dependencies
    cmds:
      - uv sync

  # ===========================================
  # FILE UTILITIES (delegates to pre-commit)
  # ===========================================
  pre-commit:
    desc: Run pre-commit hooks on all files
    cmds:
      - uv run pre-commit run --all-files

  # ===========================================
  # PROJECT CHECKS (single source of truth)
  # ===========================================
  lint:
    desc: Run ruff linter
    cmds:
      - uv run ruff check .

  lint-fix:
    desc: Run ruff linter with auto-fix
    cmds:
      - uv run ruff check --fix .

  format:
    desc: Format code with ruff
    cmds:
      - uv run ruff format .

  format-check:
    desc: Check code formatting with ruff
    cmds:
      - uv run ruff format --check .

  test:
    desc: Run tests
    cmds:
      - uv run pytest

  # ===========================================
  # COMPOSITE TASKS
  # ===========================================
{% if project_type == 'base' %}
  check:
    desc: Run all CI checks
    cmds:
      - task: pre-commit
      - task: test
{% elif project_type == 'package' %}
  check:
    desc: Run all CI checks
    cmds:
      - task: pre-commit
      - task: test
      - task: docs
      - task: build
{% elif project_type == 'pipeline-kfp' %}
  check:
    desc: Run all CI checks
    cmds:
      - task: pre-commit
      - task: test
      - task: docs
{% endif %}
{% if project_type in ['package', 'pipeline-kfp'] %}

  # ===========================================
  # DOCUMENTATION
  # ===========================================
  docs:
    desc: Build HTML documentation locally
    cmds:
      - uv run sphinx-build -b html docs docs/_build/html

  docs-clean:
    desc: Remove built documentation
    cmds:
      - rm -rf docs/_build
{% endif %}
{% if project_type == 'package' %}

  # ===========================================
  # PACKAGE BUILD
  # ===========================================
  build:
    desc: Build the package
    cmds:
      - uv build
{% endif %}
{% if project_type == 'pipeline-kfp' %}

  # ===========================================
  # PIPELINE TASKS
  # ===========================================
  compile:
    desc: Compile pipeline to JSON (placeholder)
    cmds:
      - "echo 'TODO: implement compile'"

  run-local:
    desc: Run pipeline components locally (placeholder)
    cmds:
      - "echo 'TODO: implement run-local'"

  sql-fix:
    desc: Fix SQL formatting in queries/
    cmds:
      - uv run sqlfluff fix queries/
{% endif %}
